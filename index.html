<!DOCTYPE html>
<html>
<head>
<title>Anagram shuffler</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, user-scalable=no" />
<meta name="apple-mobile-web-app-capable" content="yes">
<style>
	.letter{ position:absolute; }
</style>
</head>
<body style="background-color:black; color:#AAA; overflow:hidden;">
	<div id='shuffle-space' style='margin:auto; position:relative; font-size:150%;'></div>
<script>
String.prototype.replaceAt=function(index, character) {
	return this.substr(0, index) + character + this.substr(index+character.length);
}
var shuffle_space = document.getElementById('shuffle-space');
//var text = 'james minuse stevenson';
//var shuffled = 'jauntiness moves semen';
var text = 'tom marvolo riddle';
//var shuffled = 'i am lord voldemort';
var shuffled = 'odd immortal lover';
var W = text.length*1.5;
var H = 8;
shuffle_space.style.width = W+'em';
shuffle_space.style.height = W+'em';
var started = false;
var nodes = [];
var sum_dx = 0.0; var sum_dy = 0.0;
var start_v = 0.01;
for(var i=0; i<text.length; i++) {
	var n = document.createElement('div');
	n.innerHTML = text[i];
	n.className = 'letter';
	n.x = i + W/2 - text.length/2;
	n.y = 2.0;
	n.style.top = n.y+'em';
	n.style.left = n.x+'em';
	
	var ii = shuffled.indexOf(text[i]);
	n.dest_x = ii + W/2 - text.length/2;
	shuffled = shuffled.replaceAt(ii, '#');
	n.dest_y = n.y;
	
	n.dx = Math.random()*start_v;
	n.dy = Math.random()*start_v;
	n.ddx = 0.0; n.ddy = 0.0;
	n.ddx0 = 0.0; n.ddy0 = 0.0;
	sum_dx += n.dx;
	sum_dy += n.dy;
	shuffle_space.appendChild(n);
	nodes.push(n);
}
for(var i=0; i<nodes.length; i++) {
	var n = nodes[i];
	n.dx -= sum_dx/nodes.length;
	n.dy -= sum_dy/nodes.length;
}
document.onclick = function() {
	/*for(var i=0; i<nodes.length; i++) {
		var n = nodes[i];
		n.x = n.dest_x;
		n.y = n.dest_y;
		n.style.top = n.y+'em';
		n.style.left = n.x+'em';
	}*/
	started = true;
}
var time_scale = 2*1000;
var inert_time = time_scale;
var elapsed_time = 0.0;
var previous_time=0;
function animate() {
	requestAnimationFrame(animate);
	if(!started) return;
	if(previous_time==0) previous_time = +new Date();
	var current_time = +new Date();
	var dt = current_time - previous_time;
	previous_time = current_time;
	if(dt>500) { return; } //do not count offscreen time
	if(inert_time>0) inert_time-=dt;
	else elapsed_time += dt;
	
	for(var i=0; i<nodes.length; i++) {
		var n = nodes[i];
		n.ddx0 = n.ddx;
		n.ddy0 = n.ddy;
		n.ddx = 0.0;
		n.ddy = 0.0;
	}
	
	var goal_v2 = 0.5*start_v*Math.min(time_scale-elapsed_time, 0)/time_scale;
	
	for(var i=0; i<nodes.length; i++) {
		var n = nodes[i];
		for(var j=i+1; j<nodes.length; j++) {
			var p = nodes[j];
			var px = p.x-n.x;
			var py = p.y-n.y;
			var r2 = px*px + py*py;
			var r4 = r2*r2; var r8 = r4*r4;
			n.ddx += 0.00001*px*(0.001/r4 - 1/r8);
			p.ddx -= 0.00001*px*(0.001/r4 - 1/r8);
			n.ddy += 0.00001*py*(0.001/r4 - 1/r8);
			p.ddy -= 0.00001*py*(0.001/r4 - 1/r8);
		}
		var dest_x = n.dest_x-n.x;
		var dest_y = n.dest_y-n.y;
		r2 = dest_x*dest_x + dest_y*dest_y;
		var strength = (elapsed_time/time_scale)*(elapsed_time/time_scale);
		n.ddx += 0.00001*strength*dest_x*(1/(r2+0.1));
		n.ddy += 0.00001*strength*dest_y*(1/(r2+0.1));
		//drag thermostat
		n.ddx += 0.00001*(n.dx*n.dx-goal_v2/2);
		n.ddy += 0.00001*(n.dy*n.dx-goal_v2/2);
	}
	
	var sum_v2 = 0.0;
	for(var i=0; i<nodes.length; i++) {
		var n = nodes[i];
		n.dx += 0.5*(n.ddx+n.ddx0)*dt;
		n.dy += 0.5*(n.ddy+n.ddy0)*dt;
		//random thermostat
		//n.dx += (0.5-Math.random())*0.000001*dt;
		//n.dy += (0.5-Math.random())*0.000001*dt;
		sum_v2 += n.dx*n.dx + n.dy*n.dy;
	}
	var mean_v2 = sum_v2/nodes.length;
	//averaging thermostat
	for(var i=0; i<nodes.length; i++) {
		var n = nodes[i];
		n.dx += 0.001*(goal_v2-n.dx*n.dx);
		n.dy += 0.001*(goal_v2-n.dy*n.dy);
	}
	
	
	for(var i=0; i<nodes.length; i++) {
		var n = nodes[i];
		n.x += n.dx*dt + n.ddx*dt*dt;
		n.y += n.dy*dt + n.ddy*dt*dt;
		
		if(n.x<0) { n.x=0; n.dx=-n.dx;}
		if(n.x>W) { n.x=W; n.dx=-n.dx;}
		if(n.y<0) { n.y=0; n.dy=-n.dy;}
		if(n.y>H) { n.y=H; n.dy=-n.dy;}
		
		n.style.top = n.y+'em';
		n.style.left = n.x+'em';
	}
}
animate();

</script>
</body>
</html>
